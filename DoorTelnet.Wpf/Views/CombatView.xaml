<UserControl x:Class="DoorTelnet.Wpf.Views.CombatView" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" MinWidth="320" MinHeight="260">
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="*"/>
      <RowDefinition Height="Auto"/>
    </Grid.RowDefinitions>

    <!-- Header / actions -->
    <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0 0 0 4" VerticalAlignment="Center">
      <TextBlock Text="Combat" FontWeight="Bold" FontSize="14" />
      <TextBlock Text="  ("/>
      <TextBlock Text="{Binding ActiveCombats.Count}"/>
      <TextBlock Text=" active)"/>
      <Button Content="Clear" Command="{Binding ClearHistoryCommand}" Margin="12 0 0 0" Padding="6 2" />
      <Button Content="Export" Command="{Binding ExportCsvCommand}" Margin="4 0 0 0" Padding="6 2" />
    </StackPanel>

    <!-- Summary -->
    <Border Grid.Row="1" BorderBrush="#47535F" BorderThickness="0 0 0 1" Padding="0 0 0 4" Margin="0 0 0 4">
      <UniformGrid Columns="5">
        <TextBlock Text="Total:" Foreground="#C2CCD4"/>
        <TextBlock Text="{Binding TotalCombats}"/>
        <TextBlock Text="XP:" Foreground="#C2CCD4"/>
        <TextBlock Text="{Binding TotalExperience}"/>
        <TextBlock Text=""/>
      </UniformGrid>
    </Border>

    <!-- History Table -->
    <StackPanel Grid.Row="2">
      <TextBlock Text="History" FontWeight="Bold" Margin="0 0 0 4"/>
      <DataGrid ItemsSource="{Binding CompletedCombats}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" IsReadOnly="True" RowHeaderWidth="0" FontSize="12" Height="160" HeadersVisibility="Column">
        <DataGrid.Columns>
          <DataGridTextColumn Header="Monster" Binding="{Binding MonsterName}" Width="*"/>
          <DataGridTextColumn Header="Dealt" Binding="{Binding DamageDealt}" Width="70"/>
          <DataGridTextColumn Header="Taken" Binding="{Binding DamageTaken}" Width="70"/>
          <DataGridTextColumn Header="XP" Binding="{Binding ExperienceGained}" Width="60"/>
          <DataGridTextColumn Header="Dur(s)" Binding="{Binding DurationSeconds, StringFormat=F1}" Width="70"/>
          <DataGridTextColumn Header="DPS" Binding="{Binding DpsDealt, StringFormat=F1}" Width="70"/>
          <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="90"/>
        </DataGrid.Columns>
      </DataGrid>
    </StackPanel>

    <!-- Active Combats Table -->
    <StackPanel Grid.Row="3" Margin="0 6 0 0">
      <TextBlock Text="Active" FontWeight="Bold" Margin="0 0 0 4"/>
      <DataGrid ItemsSource="{Binding ActiveCombats}" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False" IsReadOnly="True" RowHeaderWidth="0" FontSize="12" HeadersVisibility="Column">
        <DataGrid.Columns>
          <DataGridTextColumn Header="Monster" Binding="{Binding MonsterName}" Width="*"/>
          <DataGridTextColumn Header="Dealt" Binding="{Binding DamageDealt}" Width="70"/>
          <DataGridTextColumn Header="Taken" Binding="{Binding DamageTaken}" Width="70"/>
          <DataGridTextColumn Header="Dur(s)" Binding="{Binding DurationSeconds, StringFormat=F1}" Width="70"/>
          <DataGridTextColumn Header="DPS" Binding="{Binding DpsDealt, StringFormat=F1}" Width="70"/>
          <DataGridTemplateColumn Header="Target" Width="60">
            <DataGridTemplateColumn.CellTemplate>
              <DataTemplate>
                <TextBlock Text="*" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center" 
                          Visibility="{Binding IsTargeted, Converter={StaticResource BoolToVisibilityConverter}}"
                          ToolTip="This monster is currently targeted for melee combat"/>
              </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
          </DataGridTemplateColumn>
        </DataGrid.Columns>
      </DataGrid>
    </StackPanel>

    <!-- Footer stats -->
    <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Right" Opacity="0.85" Margin="0 4 0 0">
      <TextBlock Text="Avg DPS:" FontSize="11"/>
      <TextBlock Text=" "/>
      <TextBlock Text="{Binding AvgDps, StringFormat=F1}" FontSize="11"/>
      <TextBlock Text="  Win%:" FontSize="11" Margin="8 0 0 0"/>
      <TextBlock Text="{Binding WinRate, StringFormat=F1}" FontSize="11"/>
    </StackPanel>
  </Grid>
</UserControl>
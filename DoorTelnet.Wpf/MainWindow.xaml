<Window x:Class="DoorTelnet.Wpf.MainWindow"
        x:Name="RootWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:controls="clr-namespace:DoorTelnet.Wpf.Controls"
        xmlns:views="clr-namespace:DoorTelnet.Wpf.Views"
        mc:Ignorable="d"
        Title="DoorTelnet" Height="650" Width="1150" MinWidth="900" MinHeight="550"
        Icon="Resources/app_icon.ico"
        Background="{StaticResource Brush.Background}">
    <DockPanel>
        <!-- Top bar with menu and controls -->
        <Border DockPanel.Dock="Top" Background="{StaticResource Brush.Panel}" BorderBrush="{StaticResource Brush.Border}" BorderThickness="0,0,0,1" Padding="2" SnapsToDevicePixels="True">
            <DockPanel LastChildFill="True">
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center" Margin="4,0,0,0">
                    <Button x:Name="UserButton" Width="80" Margin="0,0,8,0" Content="{Binding CurrentUserButtonText}" MouseRightButtonUp="UserButton_MouseRightButtonUp" Click="UserButton_Click">
                        <Button.ContextMenu>
                            <ContextMenu ItemsSource="{Binding UserMenuItems}">
                                <ContextMenu.ItemContainerStyle>
                                    <Style TargetType="MenuItem">
                                        <Setter Property="Header" Value="{Binding Name}"/>
                                        <Setter Property="IsCheckable" Value="True"/>
                                        <Setter Property="IsChecked" Value="{Binding IsSelected, Mode=TwoWay}"/>
                                        <Setter Property="Command" Value="{Binding DataContext.SelectUserCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                        <Setter Property="CommandParameter" Value="{Binding Name}"/>
                                    </Style>
                                </ContextMenu.ItemContainerStyle>
                            </ContextMenu>
                        </Button.ContextMenu>
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
                                <Setter Property="Background" Value="{StaticResource Brush.Panel}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Padding" Value="6,3"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource Brush.AccentLight}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                    <ToggleButton x:Name="AutoGongToggle" Width="130" Margin="0,0,8,0" IsChecked="{Binding AutoGong, Mode=TwoWay}" Content="{Binding AutoGongButtonText}" Click="AutoGongToggle_Click"
                                  ToolTip="{Binding AutoGongTooltip}">
                        <ToggleButton.Style>
                            <Style TargetType="ToggleButton">
                                <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
                                <Setter Property="Background" Value="{StaticResource Brush.Panel}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Padding" Value="6,3"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource Brush.AccentLight}"/>
                                    </Trigger>
                                    <Trigger Property="IsChecked" Value="True">
                                        <Setter Property="Background" Value="{StaticResource Brush.Accent}"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource Brush.AccentLight}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ToggleButton.Style>
                    </ToggleButton>
                    <ToggleButton x:Name="AutoAttackToggle" Width="130" Margin="0,0,8,0" IsChecked="{Binding AutoAttack, Mode=TwoWay}" Content="{Binding AutoAttackButtonText}" Click="AutoAttackToggle_Click"
                                  ToolTip="{Binding AutoAttackTooltip}">
                        <ToggleButton.Style>
                            <Style TargetType="ToggleButton">
                                <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
                                <Setter Property="Background" Value="{StaticResource Brush.Panel}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Padding" Value="6,3"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource Brush.AccentLight}"/>
                                    </Trigger>
                                    <Trigger Property="IsChecked" Value="True">
                                        <Setter Property="Background" Value="{StaticResource Brush.Accent}"/>
                                        <Setter Property="BorderBrush" Value="{StaticResource Brush.AccentLight}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ToggleButton.Style>
                    </ToggleButton>
                    <Button x:Name="ConnectButton" Width="110" Content="{Binding ConnectButtonText}" Command="{Binding ToggleConnectionCommand}" Click="ConnectButton_Click">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Foreground" Value="{StaticResource Brush.Text}"/>
                                <Setter Property="Background" Value="{StaticResource Brush.Panel}"/>
                                <Setter Property="BorderBrush" Value="{StaticResource Brush.Border}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                                <Setter Property="Padding" Value="6,3"/>
                                <Setter Property="Cursor" Value="Hand"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{StaticResource Brush.AccentLight}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </StackPanel>
                <Menu Background="{StaticResource Brush.Panel}" BorderThickness="0" ItemContainerStyle="{StaticResource DarkMenuItemStyle}">
                    <MenuItem Header="_File">
                        <MenuItem Header="Settings..." Command="{Binding ShowSettingsCommand}" />
                        <Separator />
                        <MenuItem Header="Exit" Click="Exit_Click" />
                    </MenuItem>
                    <MenuItem Header="_Profiles">
                        <MenuItem Header="Credentials" Command="{Binding ShowCredentialsCommand}" />
                        <MenuItem Header="Characters" Command="{Binding ShowCharactersCommand}" />
                        <MenuItem Header="Character Sheet" Command="{Binding ShowCharacterSheetCommand}" />
                    </MenuItem>
                    <MenuItem Header="_Automation">
                        <MenuItem Header="Refresh Stats" Command="{Binding Combat.RefreshStatsCommand}" />
                        <Separator />
                        <MenuItem Header="Send Username" Command="{Binding SendUsernameCommand}" />
                        <MenuItem Header="Send Password" Command="{Binding SendPasswordCommand}" />
                        <MenuItem Header="Quick Login" Command="{Binding QuickLoginCommand}" />
                        <MenuItem Header="Send Initial Data" Command="{Binding SendInitialDataCommand}" />
                        <Separator />
                        <MenuItem Header="Clear Character Data" Command="{Binding ClearCharacterDataCommand}" 
                                  ToolTip="Clears all character data including HP, XP, location, monsters, and combat info"/>
                        <Separator />
                        <MenuItem Header="Hot Keys" Command="{Binding ShowHotKeysCommand}" />
                    </MenuItem>
                    <MenuItem Header="_Help">
                        <MenuItem Header="About" Click="About_Click" />
                        <Separator />
                        <MenuItem Header="Debug">
                            <MenuItem Header="Copy Buffer w/ Colors" Command="{Binding CopyBufferWithColorsCommand}" 
                                      ToolTip="Copy the terminal screen buffer with detailed color information - useful for debugging color-based parsing" />
                        </MenuItem>
                    </MenuItem>
                </Menu>
            </DockPanel>
        </Border>

        <!-- Main layout -->
        <Grid Margin="6">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="7*" />
                <ColumnDefinition Width="3*" />
            </Grid.ColumnDefinitions>

            <!-- Terminal full height -->
            <Border Style="{StaticResource PanelBorderStyle}" Margin="0,0,6,0" Grid.Column="0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <DockPanel Grid.Row="0" LastChildFill="False" Margin="0,0,0,6">
                        <TextBlock Text="Terminal" FontWeight="Bold" />
                    </DockPanel>
                    <controls:TerminalControl x:Name="Terminal" Grid.Row="1" Focusable="True" />
                </Grid>
            </Border>

            <!-- Right column with improved panels -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Character Stats Panel - NEW: Replaces cramped status bar -->
                <Border Style="{StaticResource PanelBorderStyle}" Margin="0,0,0,6" Grid.Row="0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Text="Character Stats" FontWeight="Bold" FontSize="12" Margin="0,0,0,6"/>
                        
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Row 0: HP -->
                            <TextBlock Grid.Row="0" Grid.Column="0" Text="HP:" FontSize="10" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,2"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" FontSize="10" Margin="0,0,0,2">
                                <Run Text="{Binding Stats.Hp, Mode=OneWay}" FontWeight="SemiBold"/>
                                <Run Text="/" Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding Stats.MaxHp, Mode=OneWay}" FontWeight="SemiBold"/>
                                <Run Text=" (" Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding Stats.HpPercent, Mode=OneWay}" FontWeight="SemiBold"/>
                                <Run Text="%)" Foreground="{StaticResource Brush.TextMuted}"/>
                            </TextBlock>
                            
                            <!-- Row 1: MP/MV -->
                            <TextBlock Grid.Row="1" Grid.Column="0" Text="MP/MV:" FontSize="10" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,2"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" FontSize="10" Margin="0,0,0,2">
                                <Run Text="{Binding Stats.Mp, Mode=OneWay}" FontWeight="SemiBold"/>
                                <Run Text=" / " Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding Stats.Mv, Mode=OneWay}" FontWeight="SemiBold"/>
                            </TextBlock>
                            
                            <!-- Row 2: Experience -->
                            <TextBlock Grid.Row="2" Grid.Column="0" Text="XP:" FontSize="10" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,2"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" FontSize="10" Margin="0,0,0,2">
                                <Run Text="{Binding Experience}" FontWeight="SemiBold"/>
                                <Run Text=" (Next: " Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding XpLeft}" FontWeight="SemiBold"/>
                                <Run Text=")" Foreground="{StaticResource Brush.TextMuted}"/>
                            </TextBlock>
                            
                            <!-- Row 3: Character -->
                            <TextBlock Grid.Row="3" Grid.Column="0" Text="Character:" FontSize="10" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,2"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding ProfileName}" FontSize="10" FontWeight="SemiBold" Margin="0,0,0,2"/>
                            
                            <!-- Row 4: Inventory/Spells -->
                            <TextBlock Grid.Row="4" Grid.Column="0" Text="Inv/Spells:" FontSize="10" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,2"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" FontSize="10" Margin="0,0,0,2">
                                <Run Text="{Binding InventoryCount}" FontWeight="SemiBold"/>
                                <Run Text=" / " Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding SpellsCount}" FontWeight="SemiBold"/>
                            </TextBlock>
                            
                            <!-- Row 5: Status -->
                            <TextBlock Grid.Row="5" Grid.Column="0" Text="Status:" FontSize="10" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,2"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" FontSize="10" Margin="0,0,0,2">
                                <Run Text="Shield:" Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding ShieldedStatus}" FontWeight="SemiBold"/>
                                <Run Text="  " />
                                <Run Text="Hunger:" Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding HungerStatus}" FontWeight="SemiBold"/>
                                <Run Text="  " />
                                <Run Text="Thirst:" Foreground="{StaticResource Brush.TextMuted}"/>
                                <Run Text="{Binding ThirstStatus}" FontWeight="SemiBold"/>
                            </TextBlock>
                            
                            <!-- Row 6: Weapon -->
                            <TextBlock Grid.Row="6" Grid.Column="0" Text="Weapon:" FontSize="10" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,0"/>
                            <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding ArmedWith}" FontSize="10" FontWeight="SemiBold" Margin="0,0,0,0"/>
                        </Grid>
                    </Grid>
                </Border>

                <Border Style="{StaticResource PanelBorderStyle}" Margin="0,0,0,6" Grid.Row="1">
                    <views:RoomView DataContext="{Binding Room}" />
                </Border>

                <Border Style="{StaticResource PanelBorderStyle}" Margin="0,0,0,6" Grid.Row="2">
                    <views:CombatView DataContext="{Binding Combat}" />
                </Border>

                <!-- Session Info Panel - NEW: Replaces non-functional log -->
                <Border Style="{StaticResource PanelBorderStyle}" Grid.Row="3">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        
                        <TextBlock Text="Session Info" FontWeight="Bold" Margin="0,0,0,6"/>
                        
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <!-- Connection Status -->
                                <Border Background="#1a1d21" BorderBrush="#333" BorderThickness="1" CornerRadius="3" Padding="8,6" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Status:" FontSize="10" FontWeight="SemiBold" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,4"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding ConnectionStatus}" FontSize="10" FontWeight="Bold" Margin="0,0,0,4">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="#4CAF50"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ConnectionStatus}" Value="Disconnected">
                                                            <Setter Property="Foreground" Value="#F44336"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding ConnectionStatus}" Value="Connected">
                                                            <Setter Property="Foreground" Value="#FFC107"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        
                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="User:" FontSize="10" FontWeight="SemiBold" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,8,0"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding CurrentUserButtonText}" FontSize="10" Margin="0,0,0,0"/>
                                    </Grid>
                                </Border>
                                
                                <!-- Combat Summary -->
                                <TextBlock Text="Combat Summary" FontSize="11" FontWeight="SemiBold" Margin="0,0,0,4"/>
                                <Border Background="#1a1d21" BorderBrush="#333" BorderThickness="1" CornerRadius="3" Padding="8,6" Margin="0,0,0,8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Battles:" FontSize="9" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,4,2"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Combat.TotalCombats}" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Right" Margin="0,0,0,2"/>
                                        
                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Total XP:" FontSize="9" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,4,2"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Combat.TotalExperience}" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Right" Margin="0,0,0,2"/>
                                        
                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Avg DPS:" FontSize="9" Foreground="{StaticResource Brush.TextMuted}" Margin="0,0,4,0"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding Combat.AvgDps, StringFormat=F1}" FontSize="9" FontWeight="SemiBold" HorizontalAlignment="Right" Margin="0,0,0,0"/>
                                    </Grid>
                                </Border>
                                
                                <!-- Quick Actions -->
                                <TextBlock Text="Quick Actions" FontSize="11" FontWeight="SemiBold" Margin="0,0,0,4"/>
                                <UniformGrid Columns="2" Margin="0,0,0,8">
                                    <Button Content="Stats" Command="{Binding Combat.RefreshStatsCommand}" Margin="0,0,2,0" Padding="4,6" FontSize="10"/>
                                    <Button Content="Init Data" Command="{Binding SendInitialDataCommand}" Margin="2,0,0,0" Padding="4,6" FontSize="10"/>
                                </UniformGrid>
                                <UniformGrid Columns="2" Margin="0,0,0,8">
                                    <Button Content="Clear Data" Command="{Binding ClearCharacterDataCommand}" Margin="0,0,2,0" Padding="4,6" FontSize="10"
                                            ToolTip="Clear all character data"/>
                                    <Button Content="Export CSV" Command="{Binding Combat.ExportCsvCommand}" Margin="2,0,0,0" Padding="4,6" FontSize="10"/>
                                </UniformGrid>
                                
                                <!-- Automation Status -->
                                <TextBlock Text="Automation" FontSize="11" FontWeight="SemiBold" Margin="0,0,0,4"/>
                                <Border Background="#1a1d21" BorderBrush="#333" BorderThickness="1" CornerRadius="3" Padding="8,6">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,4">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Auto Gong" FontSize="9" Foreground="{StaticResource Brush.TextMuted}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding AutoGong}" FontSize="9" FontWeight="SemiBold"/>
                                        </Grid>
                                        <Grid Margin="0,0,0,4">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Auto Attack" FontSize="9" Foreground="{StaticResource Brush.TextMuted}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding AutoAttack}" FontSize="9" FontWeight="SemiBold"/>
                                        </Grid>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Active Combats" FontSize="9" Foreground="{StaticResource Brush.TextMuted}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Combat.ActiveCombats.Count}" FontSize="9" FontWeight="SemiBold"/>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </DockPanel>
</Window>
